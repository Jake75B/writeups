
# Lab 1-1

This lab uses the files `Lab01-01.exe` and `Lab01-01.dll`. Use the tools and techniques described in the chapter to gain information about the files and answer the questions below.

1. Upload the files to http://www.VirusTotal.com/ and view the reports. Does either file match any existing antivirus signatures? 

By uploading both executables to virusTotal, we get these results:

Lab01-01.dll: 39/72 detected
Lab01-01.exe: 57/72 detected

This concludes that both executables show signs of malware signatures.

![](../PMA%20attatchments/Chapter%202%20-%20labs-06.11.25-paste.png)

![](../PMA%20attatchments/Chapter%202%20-%20labs-06.11.25-paste-1.png)

---

2.  **When were these files compiled?** 

Using CFF Explorer, we can view`lab01-01.exe`'s compile time in its file header. This value is stored under `TimeDateStamp`as **4D0E2FD3**.

![](../PMA%20attatchments/Solutions-18.10.25-paste-4.png)
 
 By converting this value to decimal we get **1292775379** and. This value is a unix epoch timestamp and when translating to a real timestamp we get this date:
 
![](../PMA%20attatchments/Solutions-18.10.25-paste-20.png)

The same can be done for`Lab01-01.dll` 

![](../PMA%20attatchments/Solutions-18.10.25-paste-3.png)

-  `Lab01-01.exe`compile date: Sunday, 19 December 2010, 16:16:19
- `Lab01-01.dll`compile date: Sunday,  19 December 2010, 16:16:38

---

3.  Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?

By directing our attention to the EP Section of `Lab01-01.dll`  in the image below, we can see it contains `.text`.  If it was packed, it would be empty/show unknown or it would show the packer for example `UPX1`or `.rsrc`. Additionally it is compiled using Visual C++ 6.0 which shows the binary structure hasn't been changed and therefore unpacked.

![](../PMA%20attatchments/Chapter%202%20-%20labs-01.11.25-paste.png)

`Lab-01.exe` shows the same result.

![](../PMA%20attatchments/Chapter%202%20-%20labs-01.11.25-paste%201.png)

By checking the difference in virtual size and raw size, we can see they are as follows:

Virtual size: 0x0000039E = 926 bytes
Raw size: 0x00001000 = 4096 bytes

Small differences are normal, and are due to differences between alignment in memory and on disk so this isn't a sign of packing. Therefore we can conclude that there is no packing or obsufication

![](../PMA%20attatchments/Chapter%202%20-%20labs-06.11.25-paste-2.png)

---

4. Do any imports hint at what this malware does? If so, which imports are they? 

We can see that 3 `.dll`'s are imported. We can use **Dependency walker** to take a look at the functions in the `.dll`'s

`Kernal32.dll`: Very common DLL for core functionality, such as access and manipulation of memory, files and hardware.

![](../PMA%20attatchments/Chapter%202%20-%20labs-06.11.25-paste-3.png)

**List of imports:**

- `CreateMutexA: `Creates a mutual exclusion object that can be used by malware to ensure that only a single instance of the malware is running on a system at any given time. Malware often uses fixed names for mutexes, which can be good host-based indicators to detect additional installations of the malware.

- `CreateProcessA`: Creates a new process

- `OpenMutexA`: Opens a handle to a mutual exclusion object that can be used by malware to ensure that only a single instance of malware is running on a system at any given time. Malware often uses fixed names for mutexes, which can be good host-based indicators.

- `Sleep`: Sleeps a process

![](../PMA%20attatchments/Chapter%202%20-%20labs-06.11.25-paste-4.png)



`WS2_32.dll`: Networking DLL for connecting to a network / network related tasks


![](../PMA%20attatchments/Chapter%202%20-%20labs-07.11.25-paste.png)



`MSVCRT.dll:` provides programs compiled by these versions of MSVC with most of the standard C library function

![](../PMA%20attatchments/Chapter%202%20-%20labs-07.11.25-paste-1.png)

Based on these imports can infer that the dll would likely spawn a new process and sleep (pause execution) at some point in it's execution.


Now we can take a look at `Lab01-01.exe`:

`Kernel32.dll`:

- `CloseHandle`: Closes an open object handle (file, event, mutex, thread, process, file-mapping, etc.) and releases the associated system resources.

- `CopyFileA`: Copies an existing file.

- `CreateFileA`: Creates a new file or opens an existing file.

- `CreateFileMappingA`: Creates a handle to a file mapping that loads a file into memory and makes it accessible via memory addresses. Launchers, loaders, and injectors use this function to read and modify PE files

- `FindClose`: Closes a search handle returned by FindFirstFile and frees resources used for directory enumeration.

- `FindFirstFileA`: Used to search through a directory and enumerate the filesystem.

- `FinddNextFileA`: Used to search through a directory and enumerate the filesystem.

- `IsBadReadPtr`: Attempts to verify whether a pointer points to readable memory.

- `MapViewOfFile`: Maps a file into memory and makes the contents of the file accessible via memory addresses. Launchers, loaders, and injectors use this function to read and modify PE files. By using MapViewOfFile, the malware can avoid using WriteFile to modify the contents of a file.

- `UnmapViewOfFile`: Unmaps a mapped view previously returned by MapViewOfFile, releasing the mapped address range.


When we look at the imports from, we see functions for opening and changing files, as well as the functions `FindFirstFile` and` FindNextFile`. These functions tell us that the malware searches through the filesystem, and that it can open and modify files.

![](../PMA%20attatchments/Chapter%202%20-%20labs-07.11.25-paste-2.png)

By taking a look at the `.data` section in the hex editor, we can see there is an Ascii string that shows the filepath to`kerne132.dll`. The letter change from 'L' to '1' tells us that `kerne132.dll` is attempting to disguise itself as the Windows kernel32.dll file.


---

5.  Are there any other files or host-based indicators that you could look for on infected systems?

By taking a look at the `.data` section in the hex editor, we can see there is an Ascii string that shows the filepath to`kerne132.dll`. The letter change from 'L' to '1' tells us that `kerne132.dll` is attempting to disguise itself as the Windows kernel32.dll file. This can act has a suitable IOC/host based indicator.

![](../PMA%20attatchments/Chapter%202%20-%20labs-07.11.25-paste-3.png)

---

6.  What network-based indicators could be used to find this malware on infected machines?

Taking a look at the `.data` in Lab01-01.dll , we can deduce that this IP address is contacted during the malware's execution. 

![](../PMA%20attatchments/Chapter%202%20-%20labs-07.11.25-paste-4.png)

---

7. What would you guess is the purpose of these files?

The purpose of this malware is likely a trojan / backdoor. It likely uses`Lab01-01.exe` to install `lab01-01.dll` which places the disguised `kerna132.dll` in the victims **system32** folder. It then contacts an IP which could allow remote access.


---

# Lab 1-2

1. Upload the Lab01-02.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?

Lab01-02.exe: 58/72 detected

![](../PMA%20attatchments/Chapter%202%20-%20labs-08.11.25-paste.png)


---

2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

By taking a look at the EP Section, we can see that it's`.UPX1` and not `.text`. This is an indication of packing/obfuscation.  Additionally, the compiler signiture shows `UPX -> www.upx.sourceforge.net` which is another indicator.

![](../PMA%20attatchments/Chapter%202%20-%20labs-08.11.25-paste-1.png)

By looking in **CFFexplorer**, we can see the raw size and virtual size. There is a large difference between theses sizes on all 3 sections which is another indication of packing.


![](../PMA%20attatchments/Chapter%202%20-%20labs-08.11.25-paste-2.png)

| Section | Virtual Size | Raw Size   | Packed indicator? |
| ------- | ------------ | ---------- | ----------------- |
| UPX0    | 16384 bytes  | 0 bytes    | Yes               |
| UPX1    | 4096 bytes   | 1536 bytes | Yes               |
| UPX2    | 4096 bytes   | 512 bytes  | Yes               |

Using **Dependency walker** we can see the functions imported, although `Kernel32.DLL` contains 6 imports the other 3 DLL's only contain one each, which is another indication of packing. This is a sign of packing because the import count is unnatural. A windows compiler would not create a program that imports such a small number of functions.

![](../PMA%20attatchments/Chapter%202%20-%20labs-08.11.25-paste%201.png)

To unpack malware packed with UPX, you would simply download UPX (http://upx.sourceforge.net/) and run it like so, using the packed program as input:

`upx -d PackedProgram.exe`

![](../PMA%20attatchments/Chapter%202%20-%20labs-08.11.25-paste-2%201.png)

The result is that previously hidden functions will now show.

![](../PMA%20attatchments/Chapter%202%20-%20labs-08.11.25-paste-3.png)


---

3. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

### Kernel32.DLL:

This dll alongside msvcrt.dll are very commonly imported by windows programs so they don't tell us much about this specific program.

- `SystemTimeToFileTime:` Converts a system time to file time format. System time is based on Coordinated Universal Time (UTC).

- `GetModuleFileNameA:` Returns the filename of a module that is loaded in the current process. 

- `CreateWaitableTimerA`:  Creates or opens a waitable timer object — a kernel object that can signal after a specific time interval, allowing threads or processes to synchronise or schedule actions.

- `ExitProcess`: Exit's process

- `OpenMutexA`:  Opens an existing named mutex object allowing a process to access a mutex created

- `SetWaitableTimer`:  activates or reconfigures a waitable timer object, specifying when it should become signalled and how often it should repeat.

- `WaitForSingleObject`: pauses the current thread until a specified object becomes signalled (ready), or a timeout period elapses.

- `CreateMutexA`: Creates mutex

- `CreateThread`: Creates thread

### ADVAPI32.DLL:

This DLL tells us that the program has the ability to create a service

- `CreateServiceA`:   used to create a new service in the Service Control Manager (SCM) database.

- `OpenSCManagerA`: Establishes a connection (local or remote) to the service control manager on the specified computer and opens the specified service control manager database.

- `StartServiceCtrlDispatcherA`: Connects the main thread of a service process to the service control manager, which causes the thread to be the service control dispatcher thread for the calling process.

#### WININET.DLL:

This DLL tells us that the program connects to the internet

- `InternetOpenA`: Initialises an application's use of the WinINet functions.

- `InternetOpenUrlA`: Opens a resource specified by a complete FTP or HTTP URL.


From the imports, we can determine that this program creates a service which opens a URL to a website, perhaps an adware.


---


4. What host-or network-based indicators could be used to identify this malware on infected machines?

This indicator from `.data` can be used to identify malware on infected machines. MalService is the service created from malware and it opens the URL `Malwareanalysisbook.com`. So the network can be checked for devices that have visited this site as an indicator. 

![](../PMA%20attatchments/Chapter%202%20-%20labs-11.11.25-paste.png)


--- 


# Lab 1-3


1. 1. Upload the Lab01-03.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?

Lab01-03.exe: 65/72 detected

![](../PMA%20attatchments/Chapter%202%20-%20labs-12.11.25-paste.png)

---

2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

The EP Section is empty which is a sign of packing/obfuscation, additionally the program uses **FSG** to pack it, which is a another sign.

![](../PMA%20attatchments/Chapter%202%20-%20labs-12.11.25-paste-1.png)


Additionally, we can't see the section header names which is another sign of packing. By taking a look at the differences in virtual size and raw size, we can see that this is another indicator.

![](../PMA%20attatchments/Chapter%202%20-%20labs-13.11.25-paste.png)

| Section | Virtual Size | Raw Size  | Packed indicator? |
| ------- | ------------ | --------- | ----------------- |
| N/A     | 12288 bytes  | 0 bytes   | Yes               |
| N/A     | 4096 bytes   | 652 bytes | Yes               |
| N/A     | 4096 bytes   | 512 bytes | Yes               |

---

3. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

Unlike, `UPX`, `FSG` cannot simply be unpacked so unfortunately we can't really understand the programs functionality.

---

4. What host-or network-based indicators could be used to identify this malware on infected machines?

Unfortunately we can't really understand the programs functionality without unpacking it.


---


# Lab 1-4


1. Upload the Lab01-04.exe file to http://www.VirusTotal.com/. Does it match any existing antivirus definitions?

Lab01-04.exe: 64/72 detected

![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste.png)

---

2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

Taking a look at **PEiD**, there's no signs of packing/obfuscation.

![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste-1.png)

Taking a look at the virtual size, we can see that the virtual size of the sections are lower than the raw size which doesn't point to packing/obfuscation.

![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste-2.png)


| Section | Virtual Size | Raw Size   | Packed indicator? |
| ------- | ------------ | ---------- | ----------------- |
| .text   | 1824 bytes   | 4096 bytes | No                |
| .rdata  | 978 bytes    | 4096 bytes | No                |
| .data   | 332 bytes    | 4096 bytes | No                |
| .rsrc   | 1120 bytes   | 1280 bytes | No                |


---

3. When was this program compiled?

5D69A2B3 = 1567204019 which translates to Friday, 30 August 2019 22:26:59. This can't be correct as the labs and this book was in February 2012 so therefore we can't determine the real compile time.

![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste-3.png)

---

4. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

### kernel32.dll

The imports from kernel32.dll tell us that the program loads data from the resource section (`LoadResource, FindResource, and SizeOfResource`), writes a file to disk (`CreateFile `and `WriteFile)`, and executes a file on the disk (`WinExec`). We can also guess that the program writes files to the system directory because of the calls to `GetWindowsDirectory`.

![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste-6.png)

### ADVAPI32.DLL

The imports in `ADVAPI32.DLL` tell us, that this malware can escalate permissions and access resources that require elevated permissions.

`AdjustTokenPrivileges` Enables or disables specific privileges in an access token (e.g., SeDebugPrivilege). Requires the handle to a token with TOKEN_ADJUST_PRIVILEGES access. `LookupPrivilegeValueA`Gets the LUID (Locally Unique Identifier) for a privilege name, e.g. `SeDebugPrivilege`. You need this LUID before calling `AdjustTokenPrivileges`.
`OpenProcessToken` Opens the access token for a process (usually your own or another process). You use this token to read or modify privileges with `AdjustTokenPrivileges`.

![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste-4.png)

---

 5. What host-or network-based indicators could be used to identify this malware on infected machines?

Using  **PEbear** view the ASCII strings extracted from each section, we can see some indicators such as  `www.practicalmalwareanalysis.com/updater.exe` and `system32\wupdmgr.exe` (not a system32 exe) as well as `winExec` (places a file in the windows directory). These indicators can lead us to assume that this malware uses elevated permissions to download malware from the `practicalmalwareanalysis.com` link.


![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste-5.png) 


---


 6. This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?

**Resource Hacker** shows that the resource section mostly contains binary code, with interesting part: `This program cannot be run in DOS mode.` This tells us there is an additional executable file hidden in the resource section. This is because all PE headers contain this text in their DOS headers.


![](../PMA%20attatchments/Chapter%202%20-%20labs-18.11.25-paste%201.png)


